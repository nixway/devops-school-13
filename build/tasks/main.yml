---
# tasks file for boxfuse
- name: Ensure git package is present
  ansible.builtin.package:
    name: git
    state: present
  become: yes

- name: Download project files
  ansible.builtin.git:
    repo: 'https://github.com/venkaDaria/puzzle15.git'
    dest: "{{ project_dir }}"

- name: Patch pom.xml
  ansible.builtin.blockinfile:
    path: ~/.dev/devops/devops-school/13-lesson/puzzle15/pom.xml
    append_newline: true
    marker: "<!-- {mark} ANSIBLE MANAGED BLOCK -->"
    block: |
      {% filter indent(width=4, first=true) %}
      <properties>
          <maven.compiler.source>1.8</maven.compiler.source>
          <maven.compiler.target>1.8</maven.compiler.target>
      </properties>

      <build>
          <pluginManagement>
              <plugins>
                  <plugin>
                      <artifactId>maven-war-plugin</artifactId>
                      <version>3.3.2</version>
                  </plugin>
              </plugins>
          </pluginManagement>
      </build>
      {% endfilter %}
    insertbefore: "<dependencies>"

- name: Copy Dockerfile to {{ project_dir }}
  ansible.builtin.copy:
    src: Dockerfile
    dest: "{{ project_dir }}"

- name: Ensure login on Docker Hub
  community.docker.docker_login:
    username: "{{ docker_login }}"
    password: "{{ docker_passwd }}"
    reauthorize: true

- name: Build docker image
  ansible.builtin.command:
    cmd: "docker build -t {{ docker_image_name }}:{{ docker_image_tag }} {{ project_dir }}"
    chdir: "{{ project_dir }}"

- name: Push a docker image
  ansible.builtin.command:
    cmd: "docker push {{ docker_image_name }}:{{ docker_image_tag }}"
    chdir: "{{ project_dir }}"
